<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPHERA Safety Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);
</script>
<style>
/* CSS sama seperti sebelumnya - hanya menambahkan style untuk quick filters */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #0f172a 0%, #1e293b 30%, #334155 70%, #475569 100%);
min-height: 100vh;
color: #333;
}

.container {
min-height: 100vh;
display: flex;
flex-direction: column;
}

.header {
background: rgba(15, 23, 42, 0.9);
backdrop-filter: blur(15px);
border-bottom: 1px solid rgba(148, 163, 184, 0.2);
padding: 20px 30px;
box-shadow: 0 8px 32px rgba(15, 23, 42, 0.4);
}

.header-content {
max-width: 1400px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 20px;
}

.header-title {
text-align: center;
}

.header h1 {
color: white;
font-size: 2.2em;
font-weight: 700;
text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
letter-spacing: 1px;
margin-bottom: 5px;
}

.subtitle {
color: rgba(255, 255, 255, 0.8);
font-size: 1em;
font-weight: 400;
margin: 0;
}

.header-stats {
display: flex;
gap: 20px;
flex-wrap: wrap;
}

.stat-card {
background: rgba(30, 41, 59, 0.8);
backdrop-filter: blur(15px);
border-radius: 15px;
padding: 20px 25px;
text-align: center;
border: 1px solid rgba(148, 163, 184, 0.2);
box-shadow: 0 8px 32px rgba(15, 23, 42, 0.3);
min-width: 120px;
transition: transform 0.3s ease;
}

.stat-card:hover {
transform: translateY(-5px);
background: rgba(30, 41, 59, 0.9);
box-shadow: 0 12px 40px rgba(15, 23, 42, 0.4);
border-color: rgba(59, 130, 246, 0.4);
}

.stat-number {
font-size: 2.2em;
font-weight: bold;
color: #60a5fa;
margin-bottom: 5px;
text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.stat-label {
font-size: 0.9em;
color: #cbd5e1;
font-weight: 500;
}

.main-content {
flex: 1;
padding: 30px;
max-width: 1400px;
margin: 0 auto;
width: 100%;
}

.charts-section {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
grid-template-rows: auto auto;
gap: 25px;
margin-bottom: 40px;
}

.chart-container {
background: rgba(30, 41, 59, 0.95);
border-radius: 20px;
padding: 25px;
box-shadow: 0 15px 35px rgba(15, 23, 42, 0.3);
backdrop-filter: blur(15px);
border: 1px solid rgba(148, 163, 184, 0.2);
transition: transform 0.3s ease;
}

.chart-container:hover {
transform: translateY(-3px);
background: rgba(30, 41, 59, 1);
box-shadow: 0 20px 45px rgba(15, 23, 42, 0.4);
border-color: rgba(59, 130, 246, 0.3);
}

.chart-container.wide {
grid-column: 1 / 4;
}

.chart-container h3 {
color: #e2e8f0;
margin-bottom: 20px;
font-size: 1.3em;
font-weight: 600;
text-align: center;
padding-bottom: 10px;
border-bottom: 2px solid rgba(148, 163, 184, 0.2);
}

.chart-container canvas {
max-height: 300px;
}

.filter-section {
background: rgba(30, 41, 59, 0.95);
border-radius: 20px;
padding: 25px;
margin-bottom: 30px;
box-shadow: 0 15px 35px rgba(15, 23, 42, 0.3);
border: 1px solid rgba(148, 163, 184, 0.2);
}

.filter-section h3 {
color: #e2e8f0;
margin-bottom: 20px;
font-size: 1.3em;
font-weight: 600;
text-align: center;
}

.quick-filters {
display: flex;
gap: 15px;
margin-bottom: 20px;
flex-wrap: wrap;
justify-content: center;
}

.quick-filter {
background: rgba(15, 23, 42, 0.8);
border: 2px solid rgba(148, 163, 184, 0.2);
border-radius: 25px;
padding: 10px 20px;
color: #cbd5e1;
cursor: pointer;
transition: all 0.3s ease;
font-size: 14px;
font-weight: 600;
}

.quick-filter:hover {
border-color: #60a5fa;
background: rgba(30, 41, 59, 0.9);
transform: translateY(-2px);
}

.quick-filter.active {
background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
border-color: #60a5fa;
color: white;
box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.filter-controls {
width: 100%;
}

.filter-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
align-items: end;
margin-bottom: 15px;
}

.filter-item {
display: flex;
flex-direction: column;
gap: 8px;
}

.filter-item:last-child {
display: flex;
flex-direction: column;
gap: 10px;
}

.filter-item:last-child button {
flex: 1;
min-height: 44px;
}

.filter-item label {
color: #cbd5e1;
font-size: 14px;
font-weight: 600;
margin-bottom: 5px;
}

.filter-summary {
text-align: center;
padding: 15px 20px;
background: rgba(15, 23, 42, 0.6);
border-radius: 12px;
border: 1px solid rgba(148, 163, 184, 0.2);
margin-top: 15px;
}

.summary-text {
color: #cbd5e1;
font-size: 14px;
font-weight: 500;
}

.summary-text strong {
color: #60a5fa;
font-weight: 700;
}

.filter-controls select, .filter-controls button {
width: 100%;
padding: 12px 16px;
border: 2px solid rgba(148, 163, 184, 0.2);
border-radius: 10px;
background: rgba(15, 23, 42, 0.8);
color: #e2e8f0;
font-size: 14px;
font-weight: 500;
transition: all 0.3s ease;
outline: none;
}

.filter-controls select:focus {
border-color: #60a5fa;
background: rgba(15, 23, 42, 1);
box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
}

.filter-controls button {
background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
color: white;
border: none;
cursor: pointer;
font-weight: 600;
margin-top: auto;
}

.filter-controls button:hover {
background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

#exportData {
background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
}

#exportData:hover {
background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3) !important;
}

.table-section {
background: rgba(30, 41, 59, 0.95);
border-radius: 20px;
padding: 25px;
box-shadow: 0 15px 35px rgba(15, 23, 42, 0.3);
border: 1px solid rgba(148, 163, 184, 0.2);
}

.table-section h3 {
color: #e2e8f0;
margin-bottom: 20px;
font-size: 1.3em;
font-weight: 600;
}

.table-container {
overflow-x: auto;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(15, 23, 42, 0.2);
}

table {
width: 100%;
border-collapse: collapse;
background: rgba(15, 23, 42, 0.9);
border-radius: 15px;
overflow: hidden;
}

th {
background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
color: white;
padding: 15px 10px;
text-align: left;
font-weight: 600;
font-size: 13px;
}

td {
padding: 12px 10px;
border-bottom: 1px solid rgba(148, 163, 184, 0.1);
color: #cbd5e1;
font-size: 13px;
}

tr:nth-child(even) {
background-color: rgba(30, 41, 59, 0.5);
}

tr:hover {
background-color: rgba(71, 85, 105, 0.3);
}

.status-closed {
background: #38a169;
color: white;
padding: 4px 8px;
border-radius: 6px;
font-size: 11px;
font-weight: 600;
}

.status-draft {
background: #ed8936;
color: white;
padding: 4px 8px;
border-radius: 6px;
font-size: 11px;
font-weight: 600;
}

.status-progress {
background: #3182ce;
color: white;
padding: 4px 8px;
border-radius: 6px;
font-size: 11px;
font-weight: 600;
}

.refresh-btn {
position: fixed;
top: 20px;
right: 20px;
background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
color: white;
border: none;
padding: 12px 18px;
border-radius: 10px;
cursor: pointer;
font-weight: 600;
z-index: 1000;
box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
transition: all 0.3s ease;
}

.refresh-btn:hover {
transform: scale(1.05);
background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.basic-safety-item {
background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(45, 55, 72, 0.9) 100%);
border-radius: 12px;
padding: 15px;
border: 1px solid rgba(148, 163, 184, 0.2);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}

.basic-safety-item:hover {
transform: translateY(-2px);
border-color: rgba(96, 165, 250, 0.4);
box-shadow: 0 8px 25px rgba(15, 23, 42, 0.3);
}

.basic-safety-item::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: var(--accent-color, #60a5fa);
border-radius: 12px 12px 0 0;
}

.basic-safety-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 8px;
}

.basic-safety-icon {
font-size: 1.2em;
margin-right: 8px;
}

.basic-safety-name {
color: #e2e8f0;
font-weight: 600;
font-size: 0.9em;
flex: 1;
}

.basic-safety-percentage {
color: var(--accent-color, #60a5fa);
font-weight: bold;
font-size: 1.1em;
}

.basic-safety-count {
color: #94a3b8;
font-size: 0.8em;
text-align: right;
}

.basic-safety-bar {
width: 100%;
height: 6px;
background: rgba(148, 163, 184, 0.2);
border-radius: 3px;
overflow: hidden;
margin-top: 8px;
}

.basic-safety-fill {
height: 100%;
background: linear-gradient(90deg, var(--accent-color, #60a5fa), var(--accent-light, #93c5fd));
border-radius: 3px;
transition: width 0.8s ease;
}

@media (max-width: 768px) {
.header-content {
flex-direction: column;
text-align: center;
}

.charts-section {
grid-template-columns: 1fr;
}

.filter-row {
grid-template-columns: 1fr;
}

.filter-item {
width: 100%;
}

.quick-filters {
justify-content: center;
}
}
</style>
</head>
<body>
<div class="container">
<!-- Header -->
<header class="header">
<div class="header-content">
<div class="header-title">
<h1>üõ°Ô∏è SPHERA SAFETY DASHBOARD-TIV KLATEN</h1>
<p class="subtitle">Real-time Safety Monitoring System</p>
</div>
<div class="header-stats">
<div class="stat-card">
<div class="stat-number" id="totalReports">25</div>
<div class="stat-label">Total Laporan</div>
</div>
<div class="stat-card">
<div class="stat-number" id="openReports">5</div>
<div class="stat-label">Status Open</div>
</div>
<div class="stat-card">
<div class="stat-number" id="closedReports">20</div>
<div class="stat-label">Status Close</div>
</div>
<div class="stat-card">
<div class="stat-number" id="hipoNearMissRatio">1/4</div>
<div class="stat-label">HIPO dari Near Miss</div>
</div>
</div>
</div>
</header>

<!-- Main Content -->
<main class="main-content">
<!-- Filter Section -->
<div class="filter-section">
<h3>üîç Filter Data</h3>

<!-- Quick Filters untuk HIPO dan Near Miss -->
<div class="quick-filters">
<div class="quick-filter active" data-filter="all">
<span>üìä Semua Data</span>
</div>
<div class="quick-filter" data-filter="near-miss">
<span>üîç Near Miss</span>
</div>
<div class="quick-filter" data-filter="hipo">
<span>‚ö†Ô∏è HIPO</span>
</div>
</div>

<div class="filter-controls">
<div class="filter-row">
<div class="filter-item">
<label for="monthFilter">üìÖ Bulan:</label>
<select id="monthFilter">
<option value="">Semua Bulan 2025</option>
<option value="01/2025">Januari 2025</option>
<option value="02/2025">Februari 2025</option>
<option value="03/2025">Maret 2025</option>
<option value="04/2025">April 2025</option>
<option value="05/2025">Mei 2025</option>
<option value="06/2025">Juni 2025</option>
<option value="07/2025">Juli 2025</option>
<option value="08/2025">Agustus 2025</option>
<option value="09/2025">September 2025</option>
<option value="10/2025">Oktober 2025</option>
<option value="11/2025">November 2025</option>
<option value="12/2025">Desember 2025</option>
</select>
</div>
<div class="filter-item">
<label for="departmentFilter">üè¢ Departemen:</label>
<select id="departmentFilter">
<option value="">Semua Departemen</option>
<option value="CSR">CSR</option>
<option value="SHE">SHE</option>
<option value="PIM">PIM</option>
<option value="PERFORMANCE">PERFORMANCE</option>
<option value="PRODUKSI SPS 3">PRODUKSI SPS 3</option>
<option value="TEKNIK">TEKNIK</option>
<option value="QA">QA</option>
<option value="PRODUKSI SPS 1">PRODUKSI SPS 1</option>
</select>
</div>
<div class="filter-item">
<label for="statusFilter">üìä Status:</label>
<select id="statusFilter">
<option value="">Semua Status</option>
<option value="Closed">‚úÖ Closed</option>
<option value="Draft">üìù Draft</option>
<option value="In Progress">üîÑ In Progress</option>
</select>
</div>
<div class="filter-item">
<label for="categoryFilter">üîñ Kategori:</label>
<select id="categoryFilter">
<option value="">Semua Kategori</option>
<option value="BSA">üõ°Ô∏è BSA</option>
<option value="SI">‚ö†Ô∏è SI</option>
<option value="NEAR MISS">üîç NEAR MISS</option>
</select>
</div>
<div class="filter-item">
<label for="basicSafetyFilter">ü¶∫ Basic Safety:</label>
<select id="basicSafetyFilter">
<option value="">Semua Basic Safety</option>
<option value="PPE">ü¶∫ PPE</option>
<option value="Road Safety">üöó Road Safety</option>
<option value="Housekeeping">üßπ Housekeeping</option>
<option value="Electrical Safety">‚ö° Electrical Safety</option>
<option value="Working at Height">ü™ú Working at Height</option>
<option value="Machine Safety">‚öôÔ∏è Machine Safety</option>
<option value="Material Handling">üì¶ Material Handling</option>
<option value="Emergency">üö® Emergency</option>
<option value="Contractors">üë∑ Contractors</option>
<option value="Pedestrians">üö∂ Pedestrians</option>
<option value="Gas Safety">‚õΩ Gas Safety</option>
<option value="Work Environment">üè≠ Work Environment</option>
</select>
</div>
<div class="filter-item">
<button id="resetFilter">üîÑ Reset Filter</button>
<button id="exportData">üìä Export Data</button>
</div>
</div>
</div>
<div class="filter-summary" id="filterSummary">
<span class="summary-text">Menampilkan <strong id="filteredCount">25</strong> dari <strong id="totalCount">25</strong> laporan</span>
</div>
</div>

<!-- Success Message -->
<div class="success-message" id="statusMessage">
üìä Dashboard memuat data...
</div>

<!-- Charts Section -->
<div class="charts-section">
<!-- Status Chart -->
<div class="chart-container">
<h3>Status Laporan</h3>
<canvas id="statusChart"></canvas>
</div>

<!-- Department Achievement Chart -->
<div class="chart-container">
<h3>Target Pencapaian per Departemen</h3>
<canvas id="departmentChart"></canvas>
</div>

<!-- Category Chart -->
<div class="chart-container">
<h3>Kategori Temuan</h3>
<canvas id="categoryChart"></canvas>
</div>

<!-- Monthly Trend -->
<div class="chart-container wide">
<h3>Trend Bulanan</h3>
<canvas id="monthlyChart"></canvas>
</div>
</div>

<!-- 12 Basic Safety Section -->
<div class="chart-container" style="margin-bottom: 40px;">
<h3>üõ°Ô∏è 12 Basic Safety Distribution</h3>
<div id="basicSafetyGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
<!-- Basic Safety items will be populated here -->
</div>
</div>

<!-- 12 Basic Safety Chart -->
<div class="chart-container" style="margin-bottom: 40px;">
<h3>üìä 12 Basic Safety Chart</h3>
<canvas id="basicSafetyChart"></canvas>
</div>

<!-- Data Table -->
<div class="table-section">
<h3>Data Laporan Terbaru</h3>
<div class="table-container">
<table id="reportsTable">
<thead>
<tr>
<th>No</th>
<th>Tanggal</th>
<th>Nama</th>
<th>Departemen</th>
<th>Kategori</th>
<th>Temuan</th>
<th>Status</th>
<th>HIPO</th>
</tr>
</thead>
<tbody id="tableBody">
</tbody>
</table>
</div>
</div>
</main>
</div>

<!-- Refresh Button -->
<button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh</button>

<script>
// Configuration for Google Sheets
const PUBLISHED_SHEET_ID = '2PACX-1vSldzVZONNhpIgQ9sDXsSXcqAVdgbT7COjJ1Kd0BcF_EdqeN4Ai8ak2xu7kt3RboZl67MIjqmyddLFO';
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_SHEET_ID}/pub?output=csv`;
const CORS_PROXY = `https://api.allorigins.win/get?url=${encodeURIComponent(CSV_URL)}`;

// Global variables
let spheraData = [];
let filteredData = [];
let charts = {};
let currentQuickFilter = 'all';
let isLoading = false;

// Sample data sebagai fallback
const fallbackData = [
{ no: 1, tanggal: "02/01/2025", id: "1464104", nama: "JOKO SANTOSA", dept: "CSR", kategori: "BSA", temuan: "Pedestrian banyak lumut yg belum dibersihkan", actionPlan: "Membersihkan area pedestrian", basicSafety: "Pedestrians", subKategori: "Housekeeping", posNeg: "NEG", hipo: 0, status: "Closed", keterangan: "" },
{ no: 2, tanggal: "03/01/2025", id: "1464105", nama: "ANDI SURYANTO", dept: "CSR", kategori: "BSA", temuan: "Driver tidak memakai safety belt", actionPlan: "Menegur driver untuk memakai safety belt", basicSafety: "Road Safety", subKategori: "PPE", posNeg: "NEG", hipo: 0, status: "Closed", keterangan: "" },
{ no: 3, tanggal: "15/01/2025", id: "1464268", nama: "RAHMAD SAMSUDIN", dept: "SHE", kategori: "SI", temuan: "Grill drainase terbuka berbahaya", actionPlan: "Perbaikan grill drainase", basicSafety: "Pedestrians", subKategori: "Infrastructure", posNeg: "NEG", hipo: 0, status: "Closed", keterangan: "" },
{ no: 4, tanggal: "20/02/2025", id: "1464320", nama: "SETIYA LAKSONO", dept: "PRODUKSI SPS 3", kategori: "NEAR MISS", temuan: "Hampir terperosok di area basah", actionPlan: "Penambahan warning sign", basicSafety: "Pedestrians", subKategori: "Slip Hazard", posNeg: "POS", hipo: 0, status: "Closed", keterangan: "" },
{ no: 5, tanggal: "05/02/2025", id: "1381511", nama: "JATMIKO JATMIKO", dept: "PIM", kategori: "SI", temuan: "Panel listrik tidak terkunci", actionPlan: "Pemasangan gembok panel", basicSafety: "Electrical Safety", subKategori: "LOTO", posNeg: "NEG", hipo: 1, status: "Closed", keterangan: "" },
{ no: 6, tanggal: "14/06/2025", id: "1463964", nama: "TONY PRASETYO", dept: "QA", kategori: "NEAR MISS", temuan: "Hampir tersetrum listrik", actionPlan: "Isolasi kabel listrik", basicSafety: "Electrical Safety", subKategori: "Insulation", posNeg: "POS", hipo: 1, status: "In Progress", keterangan: "" },
{ no: 7, tanggal: "15/06/2025", id: "1463965", nama: "RATNA SARI", dept: "PRODUKSI SPS 1", kategori: "SI", temuan: "Emergency shower tidak berfungsi", actionPlan: "Perbaikan emergency shower", basicSafety: "Emergency", subKategori: "Shower System", posNeg: "NEG", hipo: 1, status: "Draft", keterangan: "" },
{ no: 8, tanggal: "12/02/2025", id: "1464140", nama: "M. ANSHORI", dept: "PERFORMANCE", kategori: "BSA", temuan: "Area kerja tidak bersih", actionPlan: "Program 5S", basicSafety: "Housekeeping", subKategori: "Workplace Organization", posNeg: "NEG", hipo: 0, status: "Closed", keterangan: "" },
{ no: 9, tanggal: "28/02/2025", id: "1464298", nama: "SADLI SADLI", dept: "TEKNIK", kategori: "BSA", temuan: "Teknisi tidak menggunakan sarung tangan", actionPlan: "Penyediaan APD dan training", basicSafety: "PPE", subKategori: "PPE", posNeg: "NEG", hipo: 0, status: "Closed", keterangan: "" },
{ no: 10, tanggal: "29/03/2025", id: "1463953", nama: "SITI AMINAH", dept: "QA", kategori: "NEAR MISS", temuan: "Hampir terjatuh dari tangga", actionPlan: "Perbaikan tangga", basicSafety: "Working at Height", subKategori: "Ladder Safety", posNeg: "POS", hipo: 0, status: "Closed", keterangan: "" }
];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
console.log('‚úÖ DOM loaded, initializing dashboard...');
showSuccessMessage('üìä Loading dashboard...');

// Mulai dengan data fallback
spheraData = [...fallbackData];
filteredData = [...spheraData];

setTimeout(() => {
initializeDashboard();
setupEventListeners();
// Coba ambil data real dari Google Sheets
fetchRealData();
}, 500);
});

// Function to fetch real data from Google Sheets
async function fetchRealData() {
if (isLoading) return;
isLoading = true;
console.log('üîÑ Attempting to fetch real data from Google Sheets...');
showSuccessMessage('üîÑ Mengambil data terbaru dari Google Sheets...');

try {
let csvData = null;
let dataSource = '';

// Method 1: Direct CSV fetch
try {
console.log('üìä Trying direct CSV URL:', CSV_URL);
const response = await fetch(CSV_URL);
if (response.ok) {
csvData = await response.text();
dataSource = 'Direct CSV';
console.log('‚úÖ Success with direct CSV');
}
} catch (e) {
console.log('‚ùå Direct CSV failed:', e.message);
}

// Method 2: CORS Proxy
if (!csvData) {
try {
console.log('üìä Trying CORS proxy...');
const response = await fetch(CORS_PROXY);
if (response.ok) {
const data = await response.json();
csvData = data.contents;
dataSource = 'CORS Proxy';
console.log('‚úÖ Success with CORS proxy');
}
} catch (e) {
console.log('‚ùå CORS proxy failed:', e.message);
}
}

if (csvData) {
const realData = parseCSVData(csvData);
if (realData && realData.length > 0) {
spheraData = realData;
filteredData = [...spheraData];
console.log(`‚úÖ Real data loaded from ${dataSource}:`, spheraData.length, 'records');
console.log('üìã Sample data:', spheraData.slice(0, 3));

// Update dashboard with real data
updateDashboard();
populateFilterOptions();
showSuccessMessage(`‚úÖ Data real berhasil dimuat: ${spheraData.length} laporan dari Google Sheets (${dataSource})`);
} else {
throw new Error('No valid data found in CSV');
}
} else {
throw new Error('Failed to fetch data from all sources');
}
} catch (error) {
console.error('‚ùå Failed to load real data:', error);
showSuccessMessage(`‚ö†Ô∏è Menggunakan data demo (${spheraData.length} laporan). Error: ${error.message}`);
} finally {
isLoading = false;
}
}

// Function to parse CSV data
function parseCSVData(csvText) {
try {
console.log('üîß Parsing CSV data...');
console.log('üìÑ CSV length:', csvText.length);
console.log('üìÑ First 300 chars:', csvText.substring(0, 300));

const lines = csvText.split('\n').filter(line => line.trim() !== '');
console.log('üìÑ Total lines:', lines.length);

if (lines.length < 2) {
throw new Error('Insufficient data in spreadsheet');
}

const data = [];
// Skip header, parse data from line 1
for (let i = 1; i < lines.length; i++) {
const line = lines[i].trim();
if (!line) continue;

const values = parseCSVLine(line);

// Debug first few rows
if (i <= 5) {
console.log(`Row ${i}:`, values.slice(0, 8));
}

// Validate minimum required fields
if (values.length >= 4 && values[1] && values[3]) {
try {
const row = {
no: parseInt(values[0]) || i,
tanggal: cleanText(values[1]),
id: cleanText(values[2]),
nama: cleanText(values[3]),
dept: cleanText(values[4]),
kategori: cleanText(values[5]),
temuan: cleanText(values[6]),
actionPlan: cleanText(values[7]),
basicSafety: cleanText(values[8]),
subKategori: cleanText(values[9]),
posNeg: cleanText(values[10]),
hipo: parseInt(values[11]) || 0,
status: cleanText(values[12]) || 'Draft',
keterangan: cleanText(values[13])
};

// Only add if we have minimum required data
if (row.nama && (row.dept || row.kategori)) {
data.push(row);
}
} catch (rowError) {
console.warn(`Error parsing row ${i}:`, rowError);
}
}
}

console.log(`‚úÖ Successfully parsed ${data.length} valid records from ${lines.length} lines`);
return data;
} catch (error) {
console.error('‚ùå Error parsing CSV:', error);
return null;
}
}

// Helper function to parse CSV line (handle commas in quotes)
function parseCSVLine(line) {
const result = [];
let current = '';
let inQuotes = false;

for (let i = 0; i < line.length; i++) {
const char = line[i];
if (char === '"') {
inQuotes = !inQuotes;
} else if (char === ',' && !inQuotes) {
result.push(current.trim());
current = '';
} else {
current += char;
}
}
result.push(current.trim());
return result;
}

// Helper function to clean text
function cleanText(text) {
if (!text) return '';
return text.toString().trim().replace(/^["']|["']$/g, '');
}

// Show success/error message
function showSuccessMessage(message) {
const statusMsg = document.getElementById('statusMessage');
if (statusMsg) {
statusMsg.textContent = message;
// Auto-hide message after 10 seconds if it's not an error
if (!message.includes('Error') && !message.includes('demo')) {
setTimeout(() => {
statusMsg.style.display = 'none';
}, 10000);
}
}
}

function populateFilterOptions() {
const departments = [...new Set(spheraData.map(item => item.dept).filter(Boolean))].sort();
const categories = [...new Set(spheraData.map(item => item.kategori).filter(Boolean))].sort();

// Get unique months from data
const months = [...new Set(spheraData.map(item => {
if (item.tanggal) {
const [day, month, year] = item.tanggal.split('/');
return `${month.padStart(2, '0')}/${year}`;
}
return null;
}).filter(Boolean))].sort().reverse(); // Latest first

const monthSelect = document.getElementById('monthFilter');
const deptSelect = document.getElementById('departmentFilter');
const catSelect = document.getElementById('categoryFilter');

// Update month filter with actual data (only 2025)
monthSelect.innerHTML = '<option value="">Semua Bulan 2025</option>';
const months2025 = months.filter(monthYear => monthYear.includes('/2025'));
months2025.forEach(monthYear => {
const [month, year] = monthYear.split('/');
const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
const option = document.createElement('option');
option.value = monthYear;
option.textContent = `${monthNames[parseInt(month)]} ${year}`;
monthSelect.appendChild(option);
});

// Clear existing options except first
deptSelect.innerHTML = '<option value="">Semua Departemen</option>';
catSelect.innerHTML = '<option value="">Semua Kategori</option>';

departments.forEach(dept => {
const option = document.createElement('option');
option.value = dept;
option.textContent = dept;
deptSelect.appendChild(option);
});

categories.forEach(cat => {
const option = document.createElement('option');
option.value = cat;
option.textContent = cat;
catSelect.appendChild(option);
});
}

function initializeDashboard() {
updateHeaderStats();
updateFilterSummary();
createAllCharts();
populateTable();
}

function setupEventListeners() {
// Quick filters
document.querySelectorAll('.quick-filter').forEach(filter => {
filter.addEventListener('click', function() {
document.querySelectorAll('.quick-filter').forEach(f => f.classList.remove('active'));
this.classList.add('active');
currentQuickFilter = this.dataset.filter;
applyQuickFilter();
});
});

// Regular filters
document.getElementById('monthFilter').addEventListener('change', applyFilters);
document.getElementById('departmentFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('categoryFilter').addEventListener('change', applyFilters);
document.getElementById('basicSafetyFilter').addEventListener('change', applyFilters);
document.getElementById('resetFilter').addEventListener('click', resetFilters);
document.getElementById('exportData').addEventListener('click', exportToCSV);
}

function applyQuickFilter() {
if (currentQuickFilter === 'near-miss') {
filteredData = spheraData.filter(item => item.kategori === 'NEAR MISS');
} else if (currentQuickFilter === 'hipo') {
filteredData = spheraData.filter(item => item.hipo === 1);
} else {
filteredData = [...spheraData];
}
updateDashboard();
}

function applyFilters() {
let data = [...spheraData];

// Apply quick filter first
if (currentQuickFilter === 'near-miss') {
data = data.filter(item => item.kategori === 'NEAR MISS');
} else if (currentQuickFilter === 'hipo') {
data = data.filter(item => item.hipo === 1);
}

const monthFilter = document.getElementById('monthFilter').value;
const departmentFilter = document.getElementById('departmentFilter').value;
const statusFilter = document.getElementById('statusFilter').value;
const categoryFilter = document.getElementById('categoryFilter').value;

filteredData = data.filter(item => {
let monthMatch = true;
if (monthFilter && item.tanggal) {
const [day, month, year] = item.tanggal.split('/');
const itemMonthYear = `${month.padStart(2, '0')}/${year}`;
monthMatch = itemMonthYear === monthFilter;
}

return monthMatch &&
(!departmentFilter || item.dept === departmentFilter) &&
(!statusFilter || item.status === statusFilter) &&
(!categoryFilter || item.kategori === categoryFilter);
});

updateDashboard();
}

function resetFilters() {
document.getElementById('monthFilter').value = '';
document.getElementById('departmentFilter').value = '';
document.getElementById('statusFilter').value = '';
document.getElementById('categoryFilter').value = '';
document.getElementById('basicSafetyFilter').value = '';
document.querySelectorAll('.quick-filter').forEach(f => f.classList.remove('active'));
document.querySelector('.quick-filter[data-filter="all"]').classList.add('active');
currentQuickFilter = 'all';
filteredData = [...spheraData];
updateDashboard();
}

function updateHeaderStats() {
const total = filteredData.length;
const closed = filteredData.filter(item => item.status === 'Closed').length;
const open = total - closed;
const nearMissTotal = filteredData.filter(item => item.kategori === 'NEAR MISS').length;
const hipoFromNearMiss = filteredData.filter(item => item.kategori === 'NEAR MISS' && item.hipo === 1).length;

document.getElementById('totalReports').textContent = total;
document.getElementById('closedReports').textContent = closed;
document.getElementById('openReports').textContent = open;
document.getElementById('hipoNearMissRatio').textContent = `${hipoFromNearMiss}/${nearMissTotal}`;
}

function updateFilterSummary() {
const filteredCount = filteredData.length;
const totalCount = spheraData.length;
document.getElementById('filteredCount').textContent = filteredCount;
document.getElementById('totalCount').textContent = totalCount;
}

function createAllCharts() {
createStatusChart();
createDepartmentChart();
createCategoryChart();
createMonthlyChart();
createBasicSafetyDisplay();
createBasicSafetyChart();
}

// Status Chart dengan persentase
function createStatusChart() {
const ctx = document.getElementById('statusChart').getContext('2d');
if (charts.statusChart) charts.statusChart.destroy();

const statusCounts = {};
filteredData.forEach(item => {
const status = item.status || 'Unknown';
statusCounts[status] = (statusCounts[status] || 0) + 1;
});

const total = filteredData.length;

charts.statusChart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: Object.keys(statusCounts),
datasets: [{
data: Object.values(statusCounts),
backgroundColor: ['#38a169', '#ed8936', '#3182ce', '#e53e3e'],
borderWidth: 3,
borderColor: '#1e293b'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
cutout: '60%',
plugins: {
legend: {
position: 'bottom',
labels: {
color: '#cbd5e1',
usePointStyle: true
}
},
tooltip: {
backgroundColor: 'rgba(15, 23, 42, 0.95)',
titleColor: '#cbd5e1',
bodyColor: '#cbd5e1',
callbacks: {
label: function(context) {
const label = context.label || '';
const value = context.parsed;
const percentage = ((value / total) * 100).toFixed(1);
return `${label}: ${value} laporan (${percentage}%)`;
}
}
},
datalabels: {
color: '#ffffff',
font: {
weight: 'bold',
size: 14
},
formatter: (value, context) => {
const percentage = ((value / total) * 100).toFixed(1);
return percentage + '%';
}
}
}
},
plugins: [{
id: 'centerText',
beforeDraw: function(chart) {
const ctx = chart.ctx;
const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
ctx.font = 'bold 28px Arial';
ctx.fillStyle = '#60a5fa';
ctx.textAlign = 'center';
ctx.fillText(total, centerX, centerY - 10);
ctx.font = '14px Arial';
ctx.fillStyle = '#cbd5e1';
ctx.fillText('Total Laporan', centerX, centerY + 20);
}
}]
});
}

// Category Chart dengan persentase
function createCategoryChart() {
const ctx = document.getElementById('categoryChart').getContext('2d');
if (charts.categoryChart) charts.categoryChart.destroy();

const categoryCounts = {};
filteredData.forEach(item => {
const category = item.kategori || 'Unknown';
categoryCounts[category] = (categoryCounts[category] || 0) + 1;
});

const total = filteredData.length;

charts.categoryChart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: Object.keys(categoryCounts),
datasets: [{
data: Object.values(categoryCounts),
backgroundColor: ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#38b2ac', '#f56565'],
borderWidth: 3,
borderColor: '#1e293b'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
cutout: '60%',
plugins: {
legend: {
position: 'bottom',
labels: {
color: '#cbd5e1',
usePointStyle: true
}
},
tooltip: {
backgroundColor: 'rgba(15, 23, 42, 0.95)',
titleColor: '#cbd5e1',
bodyColor: '#cbd5e1',
callbacks: {
label: function(context) {
const label = context.label || '';
const value = context.parsed;
const percentage = ((value / total) * 100).toFixed(1);
return `${label}: ${value} laporan (${percentage}%)`;
}
}
},
datalabels: {
color: '#ffffff',
font: {
weight: 'bold',
size: 14
},
formatter: (value, context) => {
const percentage = ((value / total) * 100).toFixed(1);
return percentage + '%';
}
}
}
}
});
}

function createDepartmentChart() {
const ctx = document.getElementById('departmentChart').getContext('2d');
if (charts.departmentChart) charts.departmentChart.destroy();

const departmentTargets = {
'CSR': 8, 'SHE': 6, 'PIM': 4, 'PERFORMANCE': 3,
'PRODUKSI SPS 3': 5, 'TEKNIK': 4, 'QA': 4, 'PRODUKSI SPS 1': 3
};

const deptCounts = {};
filteredData.forEach(item => {
const dept = item.dept || 'Unknown';
if (dept !== 'Unknown') {
deptCounts[dept] = (deptCounts[dept] || 0) + 1;
}
});

const deptAchievements = [];
Object.keys(departmentTargets).forEach(dept => {
const actual = deptCounts[dept] || 0;
const target = departmentTargets[dept];
const achievement = Math.min((actual / target) * 100, 150);
deptAchievements.push({
department: dept,
achievement: achievement,
actual: actual,
target: target
});
});

deptAchievements.sort((a, b) => b.achievement - a.achievement);
const topDepartments = deptAchievements.slice(0, 6);

const colors = topDepartments.map(dept => {
if (dept.achievement >= 100) return '#22c55e';
else if (dept.achievement >= 80) return '#3b82f6';
else if (dept.achievement >= 60) return '#f59e0b';
else return '#ef4444';
});

charts.departmentChart = new Chart(ctx, {
type: 'bar',
data: {
labels: topDepartments.map(dept => dept.department),
datasets: [{
label: 'Achievement %',
data: topDepartments.map(dept => dept.achievement),
backgroundColor: colors.map(color => color + 'CC'),
borderColor: colors,
borderWidth: 2,
borderRadius: 6
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(15, 23, 42, 0.95)',
titleColor: '#cbd5e1',
bodyColor: '#cbd5e1',
callbacks: {
title: function(context) {
return topDepartments[context[0].dataIndex].department;
},
label: function(context) {
const dept = topDepartments[context.dataIndex];
return [
`Achievement: ${dept.achievement.toFixed(1)}%`,
`Actual: ${dept.actual} laporan`,
`Target: ${dept.target} laporan`
];
}
}
}
},
scales: {
y: {
beginAtZero: true,
max: 150,
ticks: {
color: '#cbd5e1',
callback: function(value) { return value + '%'; }
},
grid: { color: 'rgba(148, 163, 184, 0.1)' }
},
x: {
ticks: { color: '#cbd5e1', maxRotation: 45 },
grid: { color: 'rgba(148, 163, 184, 0.1)' }
}
}
}
});
}

function createMonthlyChart() {
const ctx = document.getElementById('monthlyChart').getContext('2d');
if (charts.monthlyChart) charts.monthlyChart.destroy();

const monthCounts = {};
filteredData.forEach(item => {
if (item.tanggal) {
try {
const [day, month, year] = item.tanggal.split('/');
if (day && month && year) {
const monthKey = `${year}-${month.padStart(2, '0')}`;
monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
}
} catch (e) {
console.warn('Error parsing date:', item.tanggal, e);
}
}
});

let sortedMonths = Object.keys(monthCounts).sort();
const chartData = sortedMonths.map(month => monthCounts[month] || 0);
const chartLabels = sortedMonths.map(month => {
const [year, monthNum] = month.split('-');
const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
});

charts.monthlyChart = new Chart(ctx, {
type: 'line',
data: {
labels: chartLabels,
datasets: [{
label: 'Jumlah Laporan',
data: chartData,
borderColor: '#60a5fa',
backgroundColor: 'rgba(96, 165, 250, 0.2)',
borderWidth: 3,
fill: true,
tension: 0.4,
pointBackgroundColor: '#60a5fa',
pointBorderColor: '#ffffff',
pointBorderWidth: 2,
pointRadius: 6
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(15, 23, 42, 0.95)',
titleColor: '#cbd5e1',
bodyColor: '#cbd5e1',
callbacks: {
label: function(context) {
return `Jumlah Laporan: ${context.parsed.y}`;
}
}
}
},
scales: {
y: {
beginAtZero: true,
ticks: { color: '#cbd5e1', stepSize: 1 },
grid: { color: 'rgba(148, 163, 184, 0.15)' }
},
x: {
ticks: { color: '#cbd5e1', maxRotation: 45 },
grid: { color: 'rgba(148, 163, 184, 0.15)' }
}
}
}
});
}

// 12 Basic Safety Display (Cards)
function createBasicSafetyDisplay() {
console.log('üõ°Ô∏è Creating 12 Basic Safety display...');

// Define 12 Basic Safety categories with icons and colors
const basicSafetyCategories = {
'PPE': { icon: 'ü¶∫', name: 'Personal Protective Equipment', color: '#3b82f6', lightColor: '#93c5fd' },
'Road Safety': { icon: 'üöó', name: 'Road Safety', color: '#ef4444', lightColor: '#fca5a5' },
'Housekeeping': { icon: 'üßπ', name: 'Housekeeping', color: '#22c55e', lightColor: '#86efac' },
'Electrical Safety': { icon: '‚ö°', name: 'Electrical Safety', color: '#f59e0b', lightColor: '#fcd34d' },
'Working at Height': { icon: 'ü™ú', name: 'Working at Height', color: '#8b5cf6', lightColor: '#c4b5fd' },
'Machine Safety': { icon: '‚öôÔ∏è', name: 'Machine Safety', color: '#06b6d4', lightColor: '#67e8f9' },
'Material Handling': { icon: 'üì¶', name: 'Material Handling', color: '#ec4899', lightColor: '#f9a8d4' },
'Emergency': { icon: 'üö®', name: 'Emergency Preparedness', color: '#dc2626', lightColor: '#f87171' },
'Contractors': { icon: 'üë∑', name: 'Contractor Safety', color: '#7c3aed', lightColor: '#a78bfa' },
'Pedestrians': { icon: 'üö∂', name: 'Pedestrian Safety', color: '#059669', lightColor: '#6ee7b7' },
'Gas Safety': { icon: '‚õΩ', name: 'Gas Safety', color: '#d97706', lightColor: '#fbbf24' },
'Work Environment': { icon: 'üè≠', name: 'Work Environment', color: '#4f46e5', lightColor: '#a5b4fc' }
};

// Count occurrences of each basic safety category
const basicSafetyCounts = {};
const total = filteredData.length;

// Initialize all categories with 0
Object.keys(basicSafetyCategories).forEach(category => {
basicSafetyCounts[category] = 0;
});

// Count actual occurrences
filteredData.forEach(item => {
const basicSafety = item.basicSafety || 'Unknown';
if (basicSafetyCounts.hasOwnProperty(basicSafety)) {
basicSafetyCounts[basicSafety]++;
} else {
// Handle variations or map to closest category
if (basicSafety.includes('PPE') || basicSafety.includes('Equipment Safety')) {
basicSafetyCounts['PPE']++;
} else if (basicSafety.includes('Road') || basicSafety.includes('Traffic')) {
basicSafetyCounts['Road Safety']++;
} else if (basicSafety.includes('Housekeeping') || basicSafety.includes('Workplace Organization')) {
basicSafetyCounts['Housekeeping']++;
} else if (basicSafety.includes('Electrical')) {
basicSafetyCounts['Electrical Safety']++;
} else if (basicSafety.includes('Height') || basicSafety.includes('Ladder')) {
basicSafetyCounts['Working at Height']++;
} else if (basicSafety.includes('Machine') || basicSafety.includes('Equipment')) {
basicSafetyCounts['Machine Safety']++;
} else if (basicSafety.includes('Material') || basicSafety.includes('Storage')) {
basicSafetyCounts['Material Handling']++;
} else if (basicSafety.includes('Emergency') || basicSafety.includes('Evacuation')) {
basicSafetyCounts['Emergency']++;
} else if (basicSafety.includes('Contractor')) {
basicSafetyCounts['Contractors']++;
} else if (basicSafety.includes('Pedestrian') || basicSafety.includes('Walking')) {
basicSafetyCounts['Pedestrians']++;
} else if (basicSafety.includes('Gas') || basicSafety.includes('Ventilation')) {
basicSafetyCounts['Gas Safety']++;
} else if (basicSafety.includes('Environment') || basicSafety.includes('Workplace')) {
basicSafetyCounts['Work Environment']++;
}
}
});

// Sort by count (descending)
const sortedBasicSafety = Object.entries(basicSafetyCounts)
.sort(([,a], [,b]) => b - a);

// Create the display
const container = document.getElementById('basicSafetyGrid');
container.innerHTML = '';

sortedBasicSafety.forEach(([category, count], index) => {
const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
const categoryInfo = basicSafetyCategories[category];

const item = document.createElement('div');
item.className = 'basic-safety-item';
item.style.setProperty('--accent-color', categoryInfo.color);
item.style.setProperty('--accent-light', categoryInfo.lightColor);

// Add rank-based styling
if (index === 0) {
item.style.borderColor = 'rgba(255, 215, 0, 0.6)'; // Gold for #1
} else if (index === 1) {
item.style.borderColor = 'rgba(192, 192, 192, 0.6)'; // Silver for #2
} else if (index === 2) {
item.style.borderColor = 'rgba(205, 127, 50, 0.6)'; // Bronze for #3
}

item.innerHTML = `
<div class="basic-safety-header">
<div style="display: flex; align-items: center;">
<span class="basic-safety-icon">${categoryInfo.icon}</span>
<span class="basic-safety-name">${categoryInfo.name}</span>
</div>
<span class="basic-safety-percentage">${percentage}%</span>
</div>
<div class="basic-safety-count">${count} laporan dari ${total}</div>
<div class="basic-safety-bar">
<div class="basic-safety-fill" style="width: ${percentage}%"></div>
</div>
`;

container.appendChild(item);
});

console.log('‚úÖ Basic Safety display created successfully');
}

// 12 Basic Safety Chart
function createBasicSafetyChart() {
const ctx = document.getElementById('basicSafetyChart').getContext('2d');
if (charts.basicSafetyChart) charts.basicSafetyChart.destroy();

// Define 12 Basic Safety categories
const basicSafetyCategories = {
'PPE': { icon: 'ü¶∫', name: 'PPE', color: '#3b82f6' },
'Road Safety': { icon: 'üöó', name: 'Road Safety', color: '#ef4444' },
'Housekeeping': { icon: 'üßπ', name: 'Housekeeping', color: '#22c55e' },
'Electrical Safety': { icon: '‚ö°', name: 'Electrical Safety', color: '#f59e0b' },
'Working at Height': { icon: 'ü™ú', name: 'Working at Height', color: '#8b5cf6' },
'Machine Safety': { icon: '‚öôÔ∏è', name: 'Machine Safety', color: '#06b6d4' },
'Material Handling': { icon: 'üì¶', name: 'Material Handling', color: '#ec4899' },
'Emergency': { icon: 'üö®', name: 'Emergency', color: '#dc2626' },
'Contractors': { icon: 'üë∑', name: 'Contractors', color: '#7c3aed' },
'Pedestrians': { icon: 'üö∂', name: 'Pedestrians', color: '#059669' },
'Gas Safety': { icon: '‚õΩ', name: 'Gas Safety', color: '#d97706' },
'Work Environment': { icon: 'üè≠', name: 'Work Environment', color: '#4f46e5' }
};

// Count occurrences
const basicSafetyCounts = {};
Object.keys(basicSafetyCategories).forEach(category => {
basicSafetyCounts[category] = 0;
});

filteredData.forEach(item => {
const basicSafety = item.basicSafety || 'Unknown';
if (basicSafetyCounts.hasOwnProperty(basicSafety)) {
basicSafetyCounts[basicSafety]++;
} else {
// Map variations to main categories
if (basicSafety.includes('PPE') || basicSafety.includes('Equipment Safety')) {
basicSafetyCounts['PPE']++;
} else if (basicSafety.includes('Road') || basicSafety.includes('Traffic')) {
basicSafetyCounts['Road Safety']++;
} else if (basicSafety.includes('Housekeeping') || basicSafety.includes('Workplace Organization')) {
basicSafetyCounts['Housekeeping']++;
} else if (basicSafety.includes('Electrical')) {
basicSafetyCounts['Electrical Safety']++;
} else if (basicSafety.includes('Height') || basicSafety.includes('Ladder')) {
basicSafetyCounts['Working at Height']++;
} else if (basicSafety.includes('Machine') || basicSafety.includes('Equipment')) {
basicSafetyCounts['Machine Safety']++;
} else if (basicSafety.includes('Material') || basicSafety.includes('Storage')) {
basicSafetyCounts['Material Handling']++;
} else if (basicSafety.includes('Emergency') || basicSafety.includes('Evacuation')) {
basicSafetyCounts['Emergency']++;
} else if (basicSafety.includes('Contractor')) {
basicSafetyCounts['Contractors']++;
} else if (basicSafety.includes('Pedestrian') || basicSafety.includes('Walking')) {
basicSafetyCounts['Pedestrians']++;
} else if (basicSafety.includes('Gas') || basicSafety.includes('Ventilation')) {
basicSafetyCounts['Gas Safety']++;
} else if (basicSafety.includes('Environment') || basicSafety.includes('Workplace')) {
basicSafetyCounts['Work Environment']++;
}
}
});

const labels = Object.keys(basicSafetyCounts);
const data = Object.values(basicSafetyCounts);
const colors = labels.map(label => basicSafetyCategories[label].color);
const total = filteredData.length;

charts.basicSafetyChart = new Chart(ctx, {
type: 'bar',
data: {
labels: labels.map(label => basicSafetyCategories[label].name),
datasets: [{
label: 'Jumlah Laporan',
data: data,
backgroundColor: colors.map(color => color + 'CC'),
borderColor: colors,
borderWidth: 2,
borderRadius: 6
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
indexAxis: 'y', // Horizontal bar chart
plugins: {
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(15, 23, 42, 0.95)',
titleColor: '#cbd5e1',
bodyColor: '#cbd5e1',
callbacks: {
title: function(context) {
const label = labels[context[0].dataIndex];
return `${basicSafetyCategories[label].icon} ${basicSafetyCategories[label].name}`;
},
label: function(context) {
const value = context.parsed.x;
const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
return [
`Jumlah: ${value} laporan`,
`Persentase: ${percentage}%`
];
}
}
},
datalabels: {
anchor: 'end',
align: 'right',
color: '#ffffff',
font: {
weight: 'bold',
size: 12
},
formatter: (value, context) => {
if (value === 0) return '';
const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
return `${value} (${percentage}%)`;
}
}
},
scales: {
x: {
beginAtZero: true,
ticks: { color: '#cbd5e1' },
grid: { color: 'rgba(148, 163, 184, 0.1)' }
},
y: {
ticks: { 
color: '#cbd5e1',
font: { size: 11 }
},
grid: { color: 'rgba(148, 163, 184, 0.1)' }
}
}
}
});
}

function populateTable() {
const tbody = document.getElementById('tableBody');
tbody.innerHTML = '';
const sortedData = [...filteredData].slice(0, 15);

sortedData.forEach(item => {
const row = document.createElement('tr');
const statusClass = item.status === 'Closed' ? 'status-closed' :
item.status === 'Draft' ? 'status-draft' : 'status-progress';

row.innerHTML = `
<td>${item.no}</td>
<td>${item.tanggal}</td>
<td>${item.nama}</td>
<td>${item.dept}</td>
<td>${item.kategori}</td>
<td title="${item.temuan}">${item.temuan.substring(0, 50)}${item.temuan.length > 50 ? '...' : ''}</td>
<td><span class="${statusClass}">${item.status}</span></td>
<td>${item.hipo}</td>
`;
tbody.appendChild(row);
});
}

function exportToCSV() {
if (filteredData.length === 0) {
alert('Tidak ada data untuk diekspor.');
return;
}

const headers = ['No', 'Tanggal', 'Nama', 'Departemen', 'Kategori', 'Temuan', 'Status', 'HIPO'];
const csvContent = [
headers.join(','),
...filteredData.map(row => [
row.no,
`"${row.tanggal}"`,
`"${row.nama}"`,
`"${row.dept}"`,
`"${row.kategori}"`,
`"${(row.temuan || '').replace(/"/g, '""')}"`,
`"${row.status}"`,
row.hipo
].join(','))
].join('\n');

const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);
link.setAttribute('href', url);

const currentDate = new Date().toISOString().split('T')[0];
const filename = `SPHERA_Safety_Report_${currentDate}.csv`;
link.setAttribute('download', filename);
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

function updateDashboard() {
updateHeaderStats();
updateFilterSummary();
createAllCharts();
populateTable();
}

function refreshDashboard() {
console.log('üîÑ Refreshing dashboard...');

// Try to fetch real data
fetchRealData();

// Show refresh feedback
const btn = document.querySelector('.refresh-btn');
const originalText = btn.innerHTML;
btn.innerHTML = 'üîÑ Loading...';
btn.style.background = '#ed8936';

setTimeout(() => {
btn.innerHTML = '‚úÖ Updated!';
btn.style.background = '#38a169';
setTimeout(() => {
btn.innerHTML = originalText;
btn.style.background = 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)';
}, 2000);
}, 1000);
}

// Auto refresh every 10 minutes
setInterval(() => {
console.log('üîÑ Auto-refreshing data from Google Sheets...');
fetchRealData();
}, 10 * 60 * 1000);

console.log('‚úÖ SPHERA Dashboard fully loaded and ready!');
console.log('üîó Will attempt to fetch data from:', CSV_URL);
</script>
</body>
</html>
